<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html> <head>
     <title>Apophenia: a library for scientific computing</title>

<!-- Google is watching. -->
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-134313-2";
urchinTracker();
</script>


     <link rel="stylesheet" href="typical.css" type="text/css" >
     <script  type="text/javascript" language="JavaScript" src="tree.js"></script>
</head><body>
     <center><table cellpadding=10pt>
     <tr> <td><img width=140px src=flake.gif alt="Patterns in static"></td> 
    <td><table>
     	<tr> <td><center><h2><a href="http://apophenia.info">Apophenia</a></h2></center></td></tr>
<tr><td><div class="qindex"><a class="qindex" href="index.html">&nbsp;Intro</a> | <a class="qindex" href="outline.html">Outline</a> | <a class="qindex" href="globals.html">Index</a> <!--| <a class="qindex" href="files.html">File&nbsp;List&nbsp;</a> -->  </div></td></tr></table>
	</td></tr></table></center>

    <div> <!--Doxygen generates an extra </div>.-->
<!-- Generated by Doxygen 1.7.6.1 -->
</div>
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">apop_mcmc.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>markit</b>(test, value)</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a3fd75cf9853d4d65144f6a1a7cc3d36e"></a><!-- doxytag: member="apop_mcmc.c::sigma_adapt" ref="a3fd75cf9853d4d65144f6a1a7cc3d36e" args="(apop_mcmc_proposal_s *ps, apop_mcmc_settings *ms)" -->
int&#160;</td><td class="memItemRight" valign="bottom"><b>sigma_adapt</b> (<a class="el" href="structapop__mcmc__proposal__s.html">apop_mcmc_proposal_s</a> *ps, <a class="el" href="structapop__mcmc__settings.html">apop_mcmc_settings</a> *ms)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a7e4038b7160e2a4ee3383ab412f19996"></a><!-- doxytag: member="apop_mcmc.c::Apop_settings_init" ref="a7e4038b7160e2a4ee3383ab412f19996" args="(Apop_settings_copy(apop_mcmc, Apop_varad_set(periods, 6e3);Apop_varad_set(burnin, 0.05);Apop_varad_set(target_accept_rate, 0.35);Apop_varad_set(gibbs_chunks, 'b');Apop_varad_set(start_at, '1');Apop_varad_set(base_step_fn, step_to_vector);Apop_varad_set(base_adapt_fn, sigma_adapt);)" -->
&#160;</td><td class="memItemRight" valign="bottom"><b>Apop_settings_init</b> (<a class="el" href="apop_8h.html#a47600802191d9ccf5d48fce70e754294">Apop_settings_copy</a>(apop_mcmc, Apop_varad_set(periods, 6e3);Apop_varad_set(burnin, 0.05);Apop_varad_set(target_accept_rate, 0.35);Apop_varad_set(gibbs_chunks, 'b');Apop_varad_set(start_at, '1');Apop_varad_set(base_step_fn, step_to_vector);Apop_varad_set(base_adapt_fn, sigma_adapt);)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a15563f46a653bfa25aadb1626270de1e"></a><!-- doxytag: member="apop_mcmc.c::Apop_settings_free" ref="a15563f46a653bfa25aadb1626270de1e" args="(apop_mcmc)" -->
&#160;</td><td class="memItemRight" valign="bottom"><b>Apop_settings_free</b> (apop_mcmc)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a0ebb5c8aa5b678855dd3f18038d499c2"></a><!-- doxytag: member="apop_mcmc.c::maybe_prep" ref="a0ebb5c8aa5b678855dd3f18038d499c2" args="(apop_data *d, apop_model *m, bool *is_a_copy)" -->
<a class="el" href="structapop__model.html">apop_model</a> *&#160;</td><td class="memItemRight" valign="bottom"><b>maybe_prep</b> (<a class="el" href="structapop__data.html">apop_data</a> *d, <a class="el" href="structapop__model.html">apop_model</a> *m, bool *is_a_copy)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="apop__mcmc_8c.html#aa28fc59f2675fd5bcd530cb7325b6c60">apop_model_metropolis_draw</a> (double *out, gsl_rng *rng, <a class="el" href="structapop__model.html">apop_model</a> *model)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a62d0ecb0b18117d54cbd825fcc9f8035"></a><!-- doxytag: member="apop_mcmc.c::main_mcmc_loop" ref="a62d0ecb0b18117d54cbd825fcc9f8035" args="(apop_data *d, apop_model *m, apop_data *out, gsl_vector *draw, apop_mcmc_settings *s, gsl_rng *rng, int *constraint_fails)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><b>main_mcmc_loop</b> (<a class="el" href="structapop__data.html">apop_data</a> *d, <a class="el" href="structapop__model.html">apop_model</a> *m, <a class="el" href="structapop__data.html">apop_data</a> *out, gsl_vector *draw, <a class="el" href="structapop__mcmc__settings.html">apop_mcmc_settings</a> *s, gsl_rng *rng, int *constraint_fails)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structapop__model.html">apop_model</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="apop__mcmc_8c.html#a733c60eab5b69d89729565a3aeeb15d9">apop_model_metropolis</a> (<a class="el" href="structapop__data.html">apop_data</a> *d, gsl_rng *rng, <a class="el" href="structapop__model.html">apop_model</a> *m)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Markov Chain Monte Carlo. </p>
</div><hr/><h2>Define Documentation</h2>
<a class="anchor" id="a774c7dd2a1de9c01b7726ebd950f37de"></a><!-- doxytag: member="apop_mcmc.c::markit" ref="a774c7dd2a1de9c01b7726ebd950f37de" args="(test, value)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define markit</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">test, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">value&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Value:</b><div class="fragment"><pre class="fragment"><span class="keywordflow">if</span> (test)  \
                s-&gt;block_starts[<span class="keyword">this</span>++] = ctr += value;
</pre></div>
</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a733c60eab5b69d89729565a3aeeb15d9"></a><!-- doxytag: member="apop_mcmc.c::apop_model_metropolis" ref="a733c60eab5b69d89729565a3aeeb15d9" args="(apop_data *d, gsl_rng *rng, apop_model *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structapop__model.html">apop_model</a>* <a class="el" href="apop__mcmc_8c.html#a733c60eab5b69d89729565a3aeeb15d9">apop_model_metropolis</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structapop__data.html">apop_data</a> *&#160;</td>
          <td class="paramname"><em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gsl_rng *&#160;</td>
          <td class="paramname"><em>rng</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structapop__model.html">apop_model</a> *&#160;</td>
          <td class="paramname"><em>m</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Use <a href="https://en.wikipedia.org/wiki/Metropolis-Hastings">Metropolis-Hastings Markov chain Monte Carlo</a> to make draws from the given model.</p>
<p>The basic storyline is that draws are made from a proposal distribution, and the likelihood of your model given your data and the drawn parameters evaluated. At each step, a new set of proposal parameters are drawn, and if either they are more likely than the previous set the new proposal is accepted as the next step, else with probability (prob of new params)/(prob of old params), they are accepted as the next step anyway. Otherwise the last accepted proposal is repeated.</p>
<p>The output is an <a class="el" href="group__models.html#gaca8f3323c57e0223a9f3c0f991c9760e">apop_pmf</a> model with a data set listing the draws that were accepted, including those repetitions. The output model is modified so that subsequent draws are one more step from the Markov chain, via <a class="el" href="apop__model_8c.html#ac8a700ba4b9678433d2f84938c1c515f">apop_model_metropolis_draw</a>.</p>
<ul>
<li>If a proposal fails to meet the <code>constraint</code> element of the model you input, then the proposal is thrown out and a new one selected. By the default proposal distribution, this is not mathematically correct (it breaks detailed balance), and values near the constraint will be oversampled. The output model will have <code>outmodel-&gt;error=='c'</code>. It is up to you to decide whether the resulting distribution is good enough for your purposes or whether to take the time to write a custom proposal and step function to accommodate the constraint.</li>
</ul>
<p>Attach an <a class="el" href="structapop__mcmc__settings.html">apop_mcmc_settings</a> group to your model to specify the proposal distribution, burnin, and other details of the search. See the <a class="el" href="structapop__mcmc__settings.html">apop_mcmc_settings</a> documentation for details.</p>
<ul>
<li>The default proposal includes an adaptive step: you specify a target accept rate (default: .35), and if the accept rate is currently higher the variance of the proposals is widened to explore more of the space; if the accept rate is currently lower the variance is narrowed to stay closer to the last accepted proposal. Technically, this breaks ergodicity of the Markov chain, but the consensus seems to be that this is not a serious problem. If it does concern you, you can set the <code>base_adapt_fn</code> in the <a class="el" href="structapop__mcmc__settings.html">apop_mcmc_settings</a> group to a do-nothing function, or one that damps its adaptation as <img class="formulaInl" alt="$n\to\infty$" src="form_42.png"/>.</li>
</ul>
<ul>
<li>Note the <code>gibbs_chunks</code> element of the <a class="el" href="structapop__mcmc__settings.html">apop_mcmc_settings</a> group. If you set <code>gibbs_chunks='a'</code>, all parameters are drawn as a set, and accepted/rejected as a set. The variances are adapted at an identical rate. If you set <code>gibbs_chunks='i'</code>, then each scalar parameter is assigned its own proposal distribution, which is adapted at its own pace. With <code>gibbs_chunks='b'</code> (the default), then each of the vector, matrix, and weights of your model's parameters are drawn/accepted/adapted as a group (and so on to additional chunks if your model has <code>-&gt;more</code> pages). This works well for complex models which naturally break down into subsets of parameters.</li>
</ul>
<p>Each chunk counts as a step in the Markov chain. Therefore, if there are several chunks, you can expect chunks to repeat from step to step. If you want a draw after cycling through all chunks, try using <a class="el" href="apop__model_8c.html#ac8a700ba4b9678433d2f84938c1c515f">apop_model_metropolis_draw</a>, which has that behavior.</p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">d</td><td>The <a class="el" href="gentle.html#apop_data">apop_data</a> set used for evaluating the likelihood of a proposed parameter set.</td></tr>
    <tr><td class="paramname">rng</td><td>A <code>gsl_rng</code>, probably allocated via <a class="el" href="group__convenience__fns.html#gada044cf02135422a9f9292b6054c86dd">apop_rng_alloc</a>. (Default: an RNG from <a class="el" href="apop_8h.html#a1e829ce2396bf05ab10460bcc37aeeab">apop_rng_get_thread</a>)</td></tr>
    <tr><td class="paramname">m</td><td>The <a class="el" href="structapop__model.html">apop_model</a> from which parameters are being drawn. (No default; must not be <code>NULL</code>)</td></tr>
  </table>
  </dd>
</dl>
<ul>
<li>If the likelihood model no parameters, I will allocate them. That means you can use one of the stock models that ship with Apophenia. If I need to run the model's prep routine to get the size of the parameters, then I'll make a copy of the likelihood model, run prep, and then allocate parameters for that copy of a model.</li>
</ul>
<ul>
<li>On exit, the <code>parameters</code> element of your likelihood model has the last accepted parameter proposal.</li>
</ul>
<ul>
<li>If you set <code>apop_opts.verbose=2</code> or greater, I will report the accept rate of the M-H sampler. It is a common rule of thumb to select a proposal so that this is between 20% and 50%. Set <code>apop_opts.verbose=3</code> to see the stream of proposal points, their likelihoods, and the acceptance odds. You may want to set <code>apop_opts.log_file=fopen("yourlog", "w")</code> first.</li>
</ul>
<dl class="return"><dt><b>Returns:</b></dt><dd>A modified <a class="el" href="group__models.html#gaca8f3323c57e0223a9f3c0f991c9760e">apop_pmf</a> model representing the results of the search. It has a specialized <code>draw</code> method that returns another step from the Markov chain with each draw.</dd></dl>
<dl class="exception"><dt><b>Exceptions:</b></dt><dd>
  <table class="exception">
    <tr><td class="paramname">out-&gt;error='c'</td><td>Proposal was outside of a constraint; see above.</td></tr>
  </table>
  </dd>
</dl>
<ul>
<li>This function uses the <a class="el" href="designated.html">Designated initializers</a> syntax for inputs. </li>
</ul>

</div>
</div>
<a class="anchor" id="aa28fc59f2675fd5bcd530cb7325b6c60"></a><!-- doxytag: member="apop_mcmc.c::apop_model_metropolis_draw" ref="aa28fc59f2675fd5bcd530cb7325b6c60" args="(double *out, gsl_rng *rng, apop_model *model)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="apop__model_8c.html#ac8a700ba4b9678433d2f84938c1c515f">apop_model_metropolis_draw</a> </td>
          <td>(</td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gsl_rng *&#160;</td>
          <td class="paramname"><em>rng</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structapop__model.html">apop_model</a> *&#160;</td>
          <td class="paramname"><em>model</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The draw method for models estimated via <a class="el" href="apop__mcmc_8c.html#a733c60eab5b69d89729565a3aeeb15d9">apop_model_metropolis</a>.</p>
<p>That method produces an <a class="el" href="group__models.html#gaca8f3323c57e0223a9f3c0f991c9760e">apop_pmf</a>, typically with a few thousand draws from the model in a batch. If you want to get a single next step from the Markov chain, use this.</p>
<p>A Markov chain works by making a new draw and then accepting or rejecting the draw. If the draw is rejected, the last value is reported as the next step in the chain. Users sometimes mitigate this repetition by making a batch of draws (say, ten at a time) and using only the last.</p>
<p>If you run this without first running <a class="el" href="apop__mcmc_8c.html#a733c60eab5b69d89729565a3aeeb15d9">apop_model_metropolis</a>, I will run it for you, meaning that there will be an initial burn-in period before the first draw that can be reported to you. That run is done using <code>model-&gt;data</code> as input.</p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">out</td><td>An array of <code>doubles</code>, which will hold the draw, in the style of <a class="el" href="group__models.html#ga87f15cd1923ed7b5b46e52a77ca1dfef">apop_draw</a>. </td></tr>
    <tr><td class="paramname">rng</td><td>A <code>gsl_rng</code>, already initialized, probably via <a class="el" href="group__convenience__fns.html#gada044cf02135422a9f9292b6054c86dd">apop_rng_alloc</a>. </td></tr>
    <tr><td class="paramname">model</td><td>A model which was probably already run through <a class="el" href="apop__mcmc_8c.html#a733c60eab5b69d89729565a3aeeb15d9">apop_model_metropolis</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>On return, <code>out</code> is filled with the next step in the Markov chain. The <code>-&gt;data</code> element of the PMF model is extended to include the additional steps in the chain. If a proposal failed the model constraints, then return 1; else return 0. See the notes in the documentation for <a class="el" href="apop__mcmc_8c.html#a733c60eab5b69d89729565a3aeeb15d9">apop_model_metropolis</a>.</dd></dl>
<ul>
<li>After pulling the attached settings group, the parent model is ignored. One expects that <code>base_model</code> in the mcmc settings group == the parent model.</li>
</ul>
<ul>
<li>If your settings break the model parameters into several chunks, this function returns after stepping through all chunks. </li>
</ul>

</div>
</div>
</div><!-- contents -->
<p><p>
<div class="tiny">Autogenerated by doxygen on Sun Sep 7 2014.</div></body></html>
